<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HB Statistics â€¢ Subscriber Growth Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: radial-gradient(circle at 15% 15%, #6366f1 0%, #1e3a8a 70%);
      color: #fff;
      min-height: 100vh;
    }
    .glass {
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(12px);
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
    }
  </style>
</head>
<body class="p-6">
  <header class="text-center mb-10">
    <h1 class="text-4xl font-bold drop-shadow">ðŸ“Š HB Statistics Subscriber Growth Tracker</h1>
    <p class="text-lg mt-2 text-white/80 max-w-2xl mx-auto">
      Paste your milestones &nbsp;â†’&nbsp; get linearâ€‘smooth daily estimates, plateau fixer, and twin charts (subs & gains).
    </p>
  </header>

  <main class="max-w-5xl mx-auto space-y-10">
    <section class="glass">
      <h2 class="text-2xl font-semibold mb-3">1. Paste your data</h2>
      <label for="dataInput" class="block mb-2 text-white/80 font-medium select-none">
        Format: <code>YYYYâ€‘MMâ€‘DD,subscribers</code> â€“ commas / K / M / B accepted.
      </label>
      <textarea
        id="dataInput"
        rows="6"
        class="w-full p-4 rounded-xl bg-gradient-to-br from-white/90 to-white/70 text-black font-mono text-lg
               shadow-md border-2 border-transparent
               focus:outline-none focus:ring-4 focus:ring-indigo-400 focus:border-indigo-600
               transition-all duration-300 resize-y"
        placeholder="2025-01-01,1.2M&#10;2025-01-10,1350000"
      ></textarea>
      <button
        id="estimateBtn"
        class="mt-4 px-6 py-2 bg-emerald-400 text-black font-semibold rounded hover:bg-emerald-300 transition-colors duration-300"
      >
        Estimate âžœ
      </button>
    </section>

    <section id="resultsSection" class="hidden glass space-y-6">
      <h2 class="text-2xl font-semibold">2. Estimates</h2>
      <div class="overflow-x-auto">
        <table id="resultTable" class="min-w-full text-sm text-left"></table>
      </div>
      <div class="space-y-8">
        <canvas id="subsChart" class="w-full h-72"></canvas>
        <canvas id="gainChart" class="w-full h-60"></canvas>
      </div>
      <div class="flex flex-wrap gap-4">
        <button
          id="downloadBtn"
          class="px-5 py-2 bg-amber-300 text-black font-semibold rounded hover:bg-amber-200"
        >
          Download CSV
        </button>
        <button
          id="copyGainsVertBtn"
          class="px-5 py-2 bg-sky-300 text-black font-semibold rounded hover:bg-sky-200"
        >
          Copy Gains (Vertical)
        </button>
        <button
          id="copyGainsHorizBtn"
          class="px-5 py-2 bg-sky-300 text-black font-semibold rounded hover:bg-sky-200"
        >
          Copy Gains (Horizontal)
        </button>
      </div>
    </section>
  </main>

  <script>
    // ------------ Helpers ------------
    function parseCount(raw) {
      const m = raw.trim().toLowerCase().match(/^([\d,.]+)([kmb]?)$/);
      if (!m) return NaN;
      const n = parseFloat(m[1].replace(/,/g, ""));
      const mult = { k: 1e3, m: 1e6, b: 1e9 }[m[2]] || 1;
      return Math.round(n * mult);
    }

    function parseInput(raw) {
      return raw
        .split(/[\n\r]+/)
        .map((l) => l.trim())
        .filter(Boolean)
        .map((l) => {
          const firstComma = l.indexOf(",");
          if (firstComma === -1) throw new Error("Missing comma in: " + l);
          const dateStr = l.slice(0, firstComma).trim();
          const countStr = l.slice(firstComma + 1).trim();
          const d = new Date(dateStr);
          const c = parseCount(countStr);
          if (isNaN(d) || isNaN(c)) throw new Error("Bad entry: " + l);
          return { date: d, count: c };
        })
        .sort((a, b) => a.date - b.date);
    }

    // Linear interpolation with small random noise (~Â±3%)
    function interpolate(points) {
      const day = 86400000,
        out = [];
      for (let i = 0; i < points.length - 1; i++) {
        const s = points[i],
          e = points[i + 1];
        let days = Math.max(1, Math.round((e.date - s.date) / day));
        const total = e.count - s.count;

        // Base daily gain evenly distributed
        const baseGain = total / days;

        // Generate daily gains with small random noise Â±3%
        let gains = Array(days)
          .fill()
          .map(() => {
            const variance = 1 + (Math.random() * 0.06 - 0.03); // 0.97 to 1.03
            return baseGain * variance;
          });

        // Normalize so sum matches total exactly (rounding fix)
        const sumGains = gains.reduce((a, b) => a + b, 0);
        const correctionFactor = total / sumGains;
        gains = gains.map((g) => g * correctionFactor);

        // Round and adjust last day to fix rounding errors
        gains = gains.map((g) => Math.round(g));
        const roundingDiff = total - gains.reduce((a, b) => a + b, 0);
        gains[gains.length - 1] += roundingDiff;

        if (!out.length) out.push({ date: new Date(s.date), count: s.count });
        let c = s.count;
        for (let d = 0; d < gains.length; d++) {
          c += gains[d];
          out.push({ date: new Date(s.date.getTime() + (d + 1) * day), count: c });
        }
      }
      return out;
    }

    // Plateau smoothing for exact repeated gains of 100K or multiples with Â±10% spread
    function smoothPlateaus(data) {
      const out = data.map((r) => ({ date: new Date(r.date), count: r.count }));
      for (let i = 1; i < out.length; ) {
        const gain = out[i].count - out[i - 1].count;
        // Check if gain is multiple of 100K (e.g., 100000, 200000, 300000...)
        if (gain !== 0 && gain % 100000 === 0) {
          let start = i - 1,
            end = i;
          while (
            end + 1 < out.length &&
            out[end + 1].count - out[end].count === gain
          )
            end++;
          const len = end - start;
          if (len >= 2) {
            const total = gain * len;
            // Generate smooth distribution with Â±10% random variance around 1
            const baseGain = total / len;
            let mults = Array(len)
              .fill()
              .map(() => 0.9 + Math.random() * 0.2); // 0.9 to 1.1 approx
            const sum = mults.reduce((a, b) => a + b, 0);
            let newGains = mults.map((m) => (m / sum) * total);
            // Round gains
            newGains = newGains.map((g) => Math.round(g));
            // Fix rounding diff on last
            const diff = total - newGains.reduce((a, b) => a + b, 0);
            newGains[newGains.length - 1] += diff;
            let c = out[start].count;
            for (let d = 0; d < len; d++) {
              c += newGains[d];
              out[start + 1 + d].count = c;
            }
          }
          i = end + 1;
        } else i++;
      }
      return out;
    }

    // ------------ Rendering ------------
    let subsChart,
      gainChart,
      gainsArr = [];

    function renderTable(data) {
      const tbl = document.getElementById("resultTable");
      tbl.innerHTML =
        '<thead><tr class="border-b border-white/25 text-xs uppercase"><th class="pr-4 py-2">Date</th><th class="pr-4 py-2">Subscribers</th><th class="py-2">Daily Gain</th></tr></thead><tbody></tbody>';
      const tb = tbl.querySelector("tbody");
      gainsArr = [];
      data.forEach((r, i) => {
        const g = i ? r.count - data[i - 1].count : 0;
        if (i) gainsArr.push(g);
        const row = document.createElement("tr");
        row.innerHTML = `<td class="py-1 pr-4 font-mono">${r.date
          .toISOString()
          .split("T")[0]}</td><td class="py-1 pr-4">${r.count.toLocaleString()}</td><td class="py-1 text-emerald-300 font-semibold">+${g.toLocaleString()}</td>`;
        tb.appendChild(row);
      });
    }

    function buildChart(ctx, labels, data, label, color) {
      return new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{ label, data, tension: 0.25, pointRadius: 0, borderColor: color }],
        },
        options: {
          plugins: { legend: { labels: { color: "#fff" } } },
          scales: {
            x: { ticks: { color: "#fff" }, grid: { color: "rgba(255,255,255,0.12)" } },
            y: { ticks: { color: "#fff" }, grid: { color: "rgba(255,255,255,0.12)" } },
          },
        },
      });
    }

    function renderCharts(data) {
      const labels = data.map((r) => r.date.toISOString().split("T")[0]);
      const counts = data.map((r) => r.count);
      subsChart?.destroy();
      gainChart?.destroy();
      subsChart = buildChart(
        document.getElementById("subsChart").getContext("2d"),
        labels,
        counts,
        "Subscribers",
        "#4ade80"
      );
      gainChart = buildChart(
        document.getElementById("gainChart").getContext("2d"),
        labels.slice(1),
        gainsArr,
        "Daily Gain",
        "#38bdf8"
      );
    }

    function downloadCSV(data) {
      const csv =
        "Date,Subscribers\n" +
        data.map((r) => `${r.date.toISOString().split("T")[0]},${r.count}`).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      Object.assign(document.createElement("a"), { href: url, download: "subscriber_estimates.csv" }).click();
      URL.revokeObjectURL(url);
    }

    function copyGains(format) {
      const txt = gainsArr.map((g) => `+${g.toLocaleString()}`).join(format === "vertical" ? "\n" : "\t");
      navigator.clipboard.writeText(txt);
    }

    document.getElementById("estimateBtn").addEventListener("click", () => {
      const raw = document.getElementById("dataInput").value.trim();
      if (!raw) return alert("Please paste at least two data points.");
      let pts;
      try {
        pts = parseInput(raw);
      } catch (e) {
        return alert(e.message);
      }
      if (pts.length < 2) return alert("Need at least two valid data points.");
      const interp = interpolate(pts);
      const final = smoothPlateaus(interp);
      renderTable(final);
      renderCharts(final);
      document.getElementById("resultsSection").classList.remove("hidden");
      document.getElementById("downloadBtn").onclick = () => downloadCSV(final);
      document.getElementById("copyGainsVertBtn").onclick = () => copyGains("vertical");
      document.getElementById("copyGainsHorizBtn").onclick = () => copyGains("horizontal");
    });
  </script>
</body>
</html>
